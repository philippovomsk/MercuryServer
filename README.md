# MercuryServer

Печать на Меркурий 119Ф usb по локальной сети. Для печати чеков с терминального сервера или произвольного компьютера в сети пришлось написать обертку над фирменным драйвером.

Данный проект представляет собой простейший однопоточный http-сервер, который транслирует post запросы в вызовы методов com-объекта.

## Установка

Подключаем Меркурий-119Ф к компьютеру. 

Устанавливаем драйвер usb <https://www.incotexkkm.ru/attachments/54-fz/119f/Mercury_119F_USB.zip>. 

Устанавливаем драйвер "Инкотекс: ККТ Меркурий с передачей данных в ОФД (54-ФЗ)" (М119Ф, МФ) <https://forum.incotexkkm.ru/viewtopic.php?f=19&t=2066> файл MercuryOfdFPDrv.exe.

Собираем проект, например, в визуал-студии комьюнити 2017.

Вешаем в автозагрузку MercuryServer.exe.

## Настройка

В папке с MercuryServer.exe есть файл конфигурации MercuryServer.exe.config, в котором нужно настроить ip-адрес и порт ОФД. По умолчанию в качестве ОФД настроен Петер-сервис <ofd.ru>.

    <add key="ofdIP" value="94.143.160.11"/> 
    <add key="ofdPort" value="4000"/>

Так же может понадобиться изменить порт http сервера Меркурия.
    
    <add key="httpServerPort" value="8090" />

## Проверка работоспособности

Запускаем MercuryServer.exe, в панели уведомлений появляется иконка сервера. Левый клик по иконке отображает окно сервера, в котором показывается текущее состояние Меркурия 119Ф. Правый клик по иконке позволяет закрыть сервер. Перед повторным запуском стоит выждать до 30 секунд, потому что драйвер меркурия может отправлять данные в ОФД и не успеть закрыться.

В браузере в строке адреса набираем localhost:8090 нажимаем ентер, смотрим на страницу ошибки сервера Меркурия.

При настройке печати по сети аналогично в браузере компьютера, с которого будут печататься чеки, набираем айпи-адрес-серверамеркурия:8090 и смотрим страницу ошибки. Если страницы ошибки нет, то проверяем настройки брендмауэра.

## Использование

В папке драйвера Меркурия есть документация _C:\Program Files (x86)\incotex\MercuryOfdFPDriver\MercuryComOFDFPDriver Manual.pdf_ Параметры методов драйвера оборачиваются в json и передаются как тело POST-запроса.

Сервер умеет обрабатывать следующие запросы:

1. /openshift открытие смены

2. /closeshift закрытие смены

3. /status состояние фискального регистратора

4. /printxreport печать х-отчета

5. /printcheck печать чека

При печати чека проверяется состояние смены и если нужно открыть смену, то она открывается. Если нужно закрыть смену, то смена закрывается, открывается и печатается чек.

Результат возвращается в виде json, согласно документации. Если при выполнении запроса происходит ошибка, то в json возвращается поле "error" со строковым описанием ошибки.

### openshift

Тело запроса

    {
       "CashierName": "имя кассира",
       "CashierVATIN": "инн кассир"
    }

Тело ответа

    {
        "SessionNumber": номер текущей смены,
        "DocumentNumber": номер отчета об открытии смены,
        "UrgentReplacementFN":  Признак необходимости срочной замены ФН,
        "MemoryOverflowFN":  Признак переполнения памяти ФН,
        "ResourcesExhaustionFN": Признак исчерпания ресурса ФН,
        "OFDtimeout": Признак того, что подтверждение оператора для переданного фискального документа отсутствует более двух дней. Для ФД с версией ФФД 1.0 более 5 дней
    }
